import{_ as i}from"./chunks/theme.A_LnCnEA.js";import{_ as e,c as l,o as p,j as a,G as r,aG as t,a as o}from"./chunks/framework.DGtm8y85.js";const F=JSON.parse('{"title":"Dockerfile书写指南","description":"","frontmatter":{"title":"Dockerfile书写指南","author":"Zack Zheng","date":"2025/01/03 09:53","categories":["Docker专栏"],"tags":["Docker"]},"headers":[],"relativePath":"program/specialColumn/Docker专栏/Dockerfile书写指南.md","filePath":"program/specialColumn/Docker专栏/Dockerfile书写指南.md","lastUpdated":1751876631000}'),c={name:"program/specialColumn/Docker专栏/Dockerfile书写指南.md"};function h(d,s,k,u,b,m){const n=i;return p(),l("div",null,[s[0]||(s[0]=a("h4",{id:"dockerfile常用命令",tabindex:"-1"},[o("Dockerfile常用命令 "),a("a",{class:"header-anchor",href:"#dockerfile常用命令","aria-label":'Permalink to "Dockerfile常用命令"'},"​")],-1)),r(n,{src:"https://gitee.com/zackzhengxy/picGallery/raw/main/imgs/dockerfile常用指令.png"}),s[1]||(s[1]=t(`<h4 id="run执行指令" tabindex="-1">RUN执行指令 <a class="header-anchor" href="#run执行指令" aria-label="Permalink to &quot;RUN执行指令&quot;">​</a></h4><ol><li>指令写一行，也就是一个run，通过&amp;&amp;连接指令，多个RUN会导致镜像多层，体积大</li></ol><h4 id="文件复制和目录操作" tabindex="-1">文件复制和目录操作 <a class="header-anchor" href="#文件复制和目录操作" aria-label="Permalink to &quot;文件复制和目录操作&quot;">​</a></h4><p><code>COPY</code>和<code>ADD</code>都可以把本地的一个文件复制到镜像里，如果目标目录不存在，自动创建</p><p><code>ADD</code>如果复制一个gzip等压缩文件的话，会自动解压缩</p><p><code>WORKDIR</code>用于目录切换:<code>WORKFIR /app</code>就是切换到app目录(目录不存在自动创建)</p><h4 id="构建参数和环境变量-arg-vs-env" tabindex="-1">构建参数和环境变量(ARG vs ENV) <a class="header-anchor" href="#构建参数和环境变量-arg-vs-env" aria-label="Permalink to &quot;构建参数和环境变量(ARG vs ENV)&quot;">​</a></h4><p>二者都可以用来设置变量</p><h5 id="env" tabindex="-1">ENV <a class="header-anchor" href="#env" aria-label="Permalink to &quot;ENV&quot;">​</a></h5><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes one-dark-pro material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span>FROM ubuntu:20.04</span></span>
<span class="line"><span>ENV VERSION=2.0.1</span></span>
<span class="line"><span>RUN apt-get update &amp;&amp; \\</span></span>
<span class="line"><span>    apt-get install -y wget &amp;&amp; \\</span></span>
<span class="line"><span>    wget https://github.com/ipinfo/cli/releases/download/ipinfo-\${VERSION}/ipinfo_\${VERSION}_linux_amd64.tar.gz &amp;&amp; \\</span></span>
<span class="line"><span>    tar zxf ipinfo_\${VERSION}_linux_amd64.tar.gz &amp;&amp; \\</span></span>
<span class="line"><span>    mv ipinfo_\${VERSION}_linux_amd64 /usr/bin/ipinfo &amp;&amp; \\</span></span>
<span class="line"><span>    rm -rf ipinfo_\${VERSION}_linux_amd64.tar.gz</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h5 id="arg" tabindex="-1">ARG <a class="header-anchor" href="#arg" aria-label="Permalink to &quot;ARG&quot;">​</a></h5><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes one-dark-pro material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span>FROM ubuntu:20.04</span></span>
<span class="line"><span>ARG VERSION=2.0.1</span></span>
<span class="line"><span>RUN apt-get update &amp;&amp; \\</span></span>
<span class="line"><span>    apt-get install -y wget &amp;&amp; \\</span></span>
<span class="line"><span>    wget https://github.com/ipinfo/cli/releases/download/ipinfo-\${VERSION}/ipinfo_\${VERSION}_linux_amd64.tar.gz &amp;&amp; \\</span></span>
<span class="line"><span>    tar zxf ipinfo_\${VERSION}_linux_amd64.tar.gz &amp;&amp; \\</span></span>
<span class="line"><span>    mv ipinfo_\${VERSION}_linux_amd64 /usr/bin/ipinfo &amp;&amp; \\</span></span>
<span class="line"><span>    rm -rf ipinfo_\${VERSION}_linux_amd64.tar.gz</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h5 id="区别" tabindex="-1">区别 <a class="header-anchor" href="#区别" aria-label="Permalink to &quot;区别&quot;">​</a></h5><ul><li>ARG作用范围是Dockerfile和构建镜像的过程中（在build的时候可以动态指定值<code>--build-arg VERSION=2.0.0</code>）</li><li>ENV作用范围是构建镜像和容器中(ENV作为环境变量保存在容器中)</li></ul><h4 id="cmd容器启动命令" tabindex="-1">CMD容器启动命令 <a class="header-anchor" href="#cmd容器启动命令" aria-label="Permalink to &quot;CMD容器启动命令&quot;">​</a></h4><p>CMD可以用来设置容器启动时默认会执行的命令</p><ul><li>容器启动时默认执行的命令</li><li>如果docker container run启动容器时指定了其他命令，则CMD命令会被忽略</li><li>如果定义了多个CMD，只有最后一个会被执行(<code>CMD [&quot;ipinfo&quot;]</code>, 也可以写成<code>CMD[]</code>因为没有指定命令，所以在运行容器时，需要指定命令，否则报错)</li></ul><p>比如ipinfo这个镜像里面写了<code>CMD[]</code><br><code>docker container run --rm -it ipinfo ipinfo 8.8.8.8</code><br><code>--rm</code>表示运行完删除容器<br><code>-it</code>表示进入交互式<br> 第一个<code>ipinfo</code>镜像的名字<br> 第二个<code>ipinfo</code>是指定的命令<br><code>8.8.8.8</code>是命令的参数</p><h4 id="容器启动命令entrypoint" tabindex="-1">容器启动命令ENTRYPOINT <a class="header-anchor" href="#容器启动命令entrypoint" aria-label="Permalink to &quot;容器启动命令ENTRYPOINT&quot;">​</a></h4><p>ENTRYPOINT也可以设置容器启动时要执行的命令</p><h5 id="区别-1" tabindex="-1">区别： <a class="header-anchor" href="#区别-1" aria-label="Permalink to &quot;区别：&quot;">​</a></h5><ul><li><code>CMD</code>设置的命令，可以在docker container run时传入其他的命令覆盖CMD，但是<code>ENTRYPOINT</code>设置的命令一定会执行</li><li><code>ENTRYPOINT</code>和<code>CMD</code>可以联合使用，<code>ENTRYPOINT</code>设置执行的命令，<code>CMD</code>传递参数</li></ul><p>联合使用的例子:</p><div class="language-dockerfile vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">dockerfile</span><pre class="shiki shiki-themes one-dark-pro material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#61AFEF;--shiki-dark:#F78C6C;">FROM</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#BABED8;"> ubuntu:21.04</span></span>
<span class="line"><span style="--shiki-light:#61AFEF;--shiki-dark:#F78C6C;">ENTRYPOINT</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#BABED8;"> [</span><span style="--shiki-light:#98C379;--shiki-dark:#C3E88D;">&quot;echo&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#BABED8;">]</span></span>
<span class="line"><span style="--shiki-light:#61AFEF;--shiki-dark:#F78C6C;">CMD</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#BABED8;"> []</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h5 id="shell格式和exec格式" tabindex="-1">Shell格式和Exec格式 <a class="header-anchor" href="#shell格式和exec格式" aria-label="Permalink to &quot;Shell格式和Exec格式&quot;">​</a></h5><p>CMD和ENTRYPOINT都支持shell格式和Exec(可执行命令)格式</p><ul><li><p>Shell格式</p><p><code>CMD echo &quot;hello docker&quot;</code></p><p><code>ENTRYPOINT echo &quot;hello docker&quot;</code></p><div class="language-dockerfile vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">dockerfile</span><pre class="shiki shiki-themes one-dark-pro material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#61AFEF;--shiki-dark:#F78C6C;">FROM</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#BABED8;"> ubuntu:21.04</span></span>
<span class="line"><span style="--shiki-light:#61AFEF;--shiki-dark:#F78C6C;">ENV</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#BABED8;"> NAME=docker</span></span>
<span class="line"><span style="--shiki-light:#61AFEF;--shiki-dark:#F78C6C;">CMD</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#BABED8;"> echo </span><span style="--shiki-light:#98C379;--shiki-dark:#C3E88D;">&quot;hello $NAME&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li><li><p>Exec格式</p><p><code>ENTRYPOINT [&quot;echo&quot;, &quot;hello docker&quot;]</code></p><p><code>CMD [&quot;echo&quot;, &quot;hello docker&quot;]</code></p></li></ul><p>​ 上面的第三种shell需要改写如下：</p><div class="language-dockerfile vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">dockerfile</span><pre class="shiki shiki-themes one-dark-pro material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#61AFEF;--shiki-dark:#F78C6C;">FROM</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#BABED8;"> ubuntu:21.04</span></span>
<span class="line"><span style="--shiki-light:#61AFEF;--shiki-dark:#F78C6C;">ENV</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#BABED8;"> NAME=docker</span></span>
<span class="line"><span style="--shiki-light:#61AFEF;--shiki-dark:#F78C6C;">CMD</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#BABED8;"> [</span><span style="--shiki-light:#98C379;--shiki-dark:#C3E88D;">&quot;sh&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#BABED8;">, </span><span style="--shiki-light:#98C379;--shiki-dark:#C3E88D;">&quot;-c&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#BABED8;">, </span><span style="--shiki-light:#98C379;--shiki-dark:#C3E88D;">&quot;echo hello $NAME&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#BABED8;">]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="合理应用缓存" tabindex="-1">合理应用缓存 <a class="header-anchor" href="#合理应用缓存" aria-label="Permalink to &quot;合理应用缓存&quot;">​</a></h4><p>不经常改变的放在前面，经常改动的放在后面（因为改动后，从改动的语句开始，后面的语句都不会使用缓存）</p><p>比如：</p><p><code>COPY app.py /src/app.py</code>这一句可以放在<code>RUN pip install flask</code>后面</p><p>因为app.py文件经常改动，pip install flask可以应用缓存</p><h4 id="dockerignore" tabindex="-1">dockerignore <a class="header-anchor" href="#dockerignore" aria-label="Permalink to &quot;dockerignore&quot;">​</a></h4><p><code>docker image build -t flask-demo .</code></p><p>最后的.表示当前目录，会把当前目录的所有东西都作为上下文传给Docker守护进程，如果这个目录里有些在构建镜像时不需要的很大很多的文件，那么构建的时间就会很长</p><p>可以创建<code>.dockerignore</code>文件忽略不需要的文件\\夹</p><h4 id="镜像的多阶段构建" tabindex="-1">镜像的多阶段构建 <a class="header-anchor" href="#镜像的多阶段构建" aria-label="Permalink to &quot;镜像的多阶段构建&quot;">​</a></h4><p>镜像中不需要编译的环境，只需要编译的结果</p><p>两个阶段：</p><p>阶段1: 编译c代码，起名builder</p><p>阶段2: --from=builder, 运行c代码</p><div class="language-dockerfile vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">dockerfile</span><pre class="shiki shiki-themes one-dark-pro material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#61AFEF;--shiki-dark:#F78C6C;">FROM</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#BABED8;"> gcc:9.4 </span><span style="--shiki-light:#61AFEF;--shiki-dark:#F78C6C;">AS</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#BABED8;"> builder</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#61AFEF;--shiki-dark:#F78C6C;">COPY</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#BABED8;"> hello.c /src/hello.c</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#61AFEF;--shiki-dark:#F78C6C;">WORKDIR</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#BABED8;"> /src</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#61AFEF;--shiki-dark:#F78C6C;">RUN</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#BABED8;"> gcc --static -o hello hello.c</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#61AFEF;--shiki-dark:#F78C6C;">FROM</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#BABED8;"> alpine:3.13.5</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#61AFEF;--shiki-dark:#F78C6C;">COPY</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#BABED8;"> --from=builder /src/hello /src/hello</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#61AFEF;--shiki-dark:#F78C6C;">ENTRYPOINT</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#BABED8;"> [ </span><span style="--shiki-light:#98C379;--shiki-dark:#C3E88D;">&quot;/src/hello&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#BABED8;"> ]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#61AFEF;--shiki-dark:#F78C6C;">CMD</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#BABED8;"> []</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h4 id="尽量使用非root用户" tabindex="-1">尽量使用非root用户 <a class="header-anchor" href="#尽量使用非root用户" aria-label="Permalink to &quot;尽量使用非root用户&quot;">​</a></h4><ul><li><p>通过<code>groupadd</code>和<code>useradd</code>创建一个flask的组和用户</p></li><li><p>通过USER指定后面的命令要以flask这个用户的身份运行</p><p>（如下useradd的第一个flask就是groupadd创建的系统组flask，后一个flask表示用户flask）</p></li></ul><div class="language-dockerfile vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">dockerfile</span><pre class="shiki shiki-themes one-dark-pro material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#61AFEF;--shiki-dark:#F78C6C;">FROM</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#BABED8;"> python:3.9.5-slim</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#61AFEF;--shiki-dark:#F78C6C;">RUN</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#BABED8;"> pip install flask &amp;&amp; \\</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#BABED8;">    groupadd -r flask &amp;&amp; useradd -r -g flask flask &amp;&amp; \\</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#BABED8;">    mkdir /src &amp;&amp; \\</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#BABED8;">    chown -R flask:flask /src</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#61AFEF;--shiki-dark:#F78C6C;">USER</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#BABED8;"> flask</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#61AFEF;--shiki-dark:#F78C6C;">COPY</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#BABED8;"> app.py /src/app.py</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#61AFEF;--shiki-dark:#F78C6C;">WORKDIR</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#BABED8;"> /src</span></span>
<span class="line"><span style="--shiki-light:#61AFEF;--shiki-dark:#F78C6C;">ENV</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#BABED8;"> FLASK_APP=app.py</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#61AFEF;--shiki-dark:#F78C6C;">EXPOSE</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#BABED8;"> 5000</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#61AFEF;--shiki-dark:#F78C6C;">CMD</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#BABED8;"> [</span><span style="--shiki-light:#98C379;--shiki-dark:#C3E88D;">&quot;flask&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#BABED8;">, </span><span style="--shiki-light:#98C379;--shiki-dark:#C3E88D;">&quot;run&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#BABED8;">, </span><span style="--shiki-light:#98C379;--shiki-dark:#C3E88D;">&quot;-h&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#BABED8;">, </span><span style="--shiki-light:#98C379;--shiki-dark:#C3E88D;">&quot;0.0.0.0&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#BABED8;">]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div>`,47))])}const E=e(c,[["render",h]]);export{F as __pageData,E as default};
